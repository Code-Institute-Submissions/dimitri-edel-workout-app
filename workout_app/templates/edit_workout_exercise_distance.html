{% extends "base.html" %}
{% block title %}Edit Exercise Sets {% endblock title %}

{% block content %}
<h1>Edit {{ exercise.name }}</h1>
<form action="{% url 'edit_exercise_set' workout_exercise_form.instance.id %}" method="POST">
    {% csrf_token %}
    <div hidden>
        {{ workout_exercise_form }}
    </div>
    {{ exercise_set_formset.management_form }}
    <div class="container-fluid">
        <div class="row">
            <div class="col-5 entry-column">
                Distance
            </div>
            <div class="col-5 entry-column">
                Time
            </div>
            <div class="col entry-column">
                <!-- Placeholder-->
            </div>
        </div>
        {% for exercise_set_form in exercise_set_formset %}

        <div class="row">
            <div class="col-5">
                {{ exercise_set_form.distance }}
            </div>
            <div class="col-5">
                {{ exercise_set_form.time }}
            </div>
            {% if forloop.last %}
            <script>
                // The last field with time will be used to copy the results from the timer into,
                // when the stop button gets clicked
                // Also the stop_button_click() function will auto-submit this form
                let result_field_id = "{{ exercise_set_form.time.auto_id }}";
            </script>
            {% endif %}
            <div class="col">
                <a href="{% url 'delete_exercise_set' workout_exercise_form.instance.id exercise_set_form.instance.id %}"
                    class="url-link"><i class="fa-solid fa-trash-can"></i></a>
            </div>
        </div>

        {{ exercise_set_form.id }}
        {% endfor %}
    </div>
    <div class="container-fluid" style="margin-top: 10px;">
        <div class="row">
            <div class="col-5">
                <a href="{% url 'add_exercise_set' workout_exercise_id=workout_exercise_form.instance.id workout_id=workout_exercise_form.instance.workout_id %}"
                    class="url-link wo-button">
                    <i class="fa-solid fa-circle-plus"></i>New
                </a>
            </div>
            <div class="col-5">
                <a href="{% url 'edit_workout' workout_exercise_form.instance.workout_id %}" class="url-link wo-button">
                    <i class="fa-solid fa-circle-left"></i>Close
                </a>
            </div>
            <div class="col">
                <!-- Placeholder for layout consistency -->
            </div>
        </div>        
    </div>
</form>
<div class="container-fluid" style="margin-top: 10px;">
    <div class="row" >
        <div class="col-5">
            <button id="start-button" onclick="start_button_click(this)" class="wo-button"><i
                    class="fa-solid fa-play"></i>Timer</button>
        </div>
        <div class="col-5">
            <!-- Element that the timer uses for output -->
            <input type="text" id="timer-text" class="input-field">
        </div>
        <div class="col"><!-- Plaveholder --></div>
    </div>
</div>

{% load static %}
<!-- Load javascript with the timer class -->
<script src="{% static 'js/timer.js' %}"></script>
<script>
    // Auto-save the form
    function submit_form() {
        document.forms[0].submit();
    }
    // Register if the button has already been clicked
    timer_button_clicked = false;
    // Event listener for the start/stop timer button
    function start_button_click(button) {
        if (timer_button_clicked) {
            timer.stop();
            submit_form();
        } else {
            timer_button_clicked = true;
            button.innerHTML = "<i class='fa-solid fa-stop'></i>Timer";
            timer.start();
        }
    }

    /* 
        Instanciate the timer
        First parameter in the constructor specifies the id of the element that the timer uses for output

        Second parameter in the constructor specifies the output field for the results. The id for this field
        was initialized in the inline script within the form : let reult_field_id = "{{ exercise_set_form.time.auto_id }}";

        Third parameter specifies the intervals in milliseconds in which the timer will be updated
    */
    let timer = new Timer("timer-text", result_field_id, 100);

    // Functions for AUTO-SUBMITTING the form
    function getChangeableFields() {
        return document.getElementsByClassName('changeable-field');
    }

    function addOnValueChangedEventListeners() {
        changeable_fields = getChangeableFields();

        for (i = 0; i < changeable_fields.length; i++) {
            changeable_fields[i].addEventListener('input', function (event) {
                submit_form();
            });
        }
    }

    // Add event listeners to the forms from exercise_set_forms
    addOnValueChangedEventListeners();
</script>
{% endblock content %}